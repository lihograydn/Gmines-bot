// ---------------- Mines Game ----------------
let gridSize = 5;
let mines = [];
let revealed = [];
let multiplier = 1;
let stake = 50;
let totalMines = 3;
let gameActive = false;

// ---------------- Открыть экран Mines ----------------
document.getElementById('minesCard').onclick = function(){
    document.getElementById('gamesSection').style.display = 'none';
    document.getElementById('minesGameScreen').style.display = 'block';
};

// ---------------- Кнопка назад ----------------
document.getElementById('backButton').onclick = function(){
    document.getElementById('minesGameScreen').style.display = 'none';
    showSection('games');
};

// ---------------- Начать игру ----------------
document.getElementById('startGame').onclick = function(){
    stake = parseInt(document.getElementById('stakeSelect').value);
    totalMines = parseInt(document.getElementById('minesSelect').value);

    if(playerData.balance < stake){
        alert('Недостаточно баланса для ставки!');
        return;
    }

    multiplier = 1;
    revealed = [];
    mines = [];
    gameActive = true;

    document.getElementById('multiplier').innerText = multiplier.toFixed(2);
    document.getElementById('balanceGame').innerText = playerData.balance;

    const gameDiv = document.getElementById('minesGame');
    gameDiv.innerHTML = '';

    while(mines.length < totalMines){
        let r = Math.floor(Math.random() * gridSize * gridSize);
        if(!mines.includes(r)) mines.push(r);
    }

    for(let i=0;i<gridSize*gridSize;i++){
        let btn = document.createElement('div');
        btn.className = 'mineCell';
        btn.dataset.index = i;

        let img = document.createElement('img');
        img.src = 'images/question.png'; // иконка закрытой клетки
        btn.appendChild(img);

        btn.onclick = clickCell;
        gameDiv.appendChild(btn);
    }
};

// ---------------- Клик по клетке ----------------
function clickCell(){
    if(!gameActive) return;
    let idx = parseInt(this.dataset.index);
    if(revealed.includes(idx)) return;

    revealed.push(idx);
    this.innerHTML = '';
    let img = document.createElement('img');

    if(mines.includes(idx)){
        img.src = 'images/mine.png'; // иконка мины
        this.appendChild(img);
        this.style.background = '#e74c3c';
        showAllMines();
        alert('Вы наткнулись на мину! Игра окончена.');
        playerData.balance -= stake;
        gameActive = false;
        return;
    } else {
        img.src = 'images/icon.png'; // иконка безопасной клетки
        this.appendChild(img);
        this.style.background = '#2ecc71';
        multiplier *= 1.01 + (totalMines/24);
        document.getElementById('multiplier').innerText = multiplier.toFixed(2);
    }

    if(revealed.length === gridSize*gridSize - totalMines){
        showVictory();
        let win = Math.floor(stake * multiplier);
        playerData.balance += win;
        alert(`Поздравляем! Вы прошли игру и выиграли ${win} монет!`);
        gameActive = false;
    }
    document.getElementById('balanceGame').innerText = playerData.balance;
}

// ---------------- Показ всех мин ----------------
function showAllMines(){
    document.querySelectorAll('.mineCell').forEach((cell, idx)=>{
        if(mines.includes(idx)){
            cell.innerHTML = '';
            let img = document.createElement('img');
            img.src = 'images/mine.png';
            img.style.width = '40px';
            img.style.height = '40px';
            cell.appendChild(img);
            cell.style.background = '#e74c3c';
        }
    });
}

// ---------------- Показ победы ----------------
function showVictory(){
    document.querySelectorAll('.mineCell').forEach((cell, idx)=>{
        if(!mines.includes(idx)){
            cell.innerHTML = '';
            let img = document.createElement('img');
            img.src = 'images/icon.png'; // безопасная клетка
            img.style.width = '40px';
            img.style.height = '40px';
            cell.appendChild(img);
            cell.style.background = '#2ecc71';
        }
    });
}

// ---------------- Забрать выигрыш ----------------
document.getElementById('cashOut').onclick = function(){
    if(!gameActive) return;
    let win = Math.floor(stake * multiplier);
    playerData.balance += win;
    alert(`Вы забрали: ${win} монет!`);
    gameActive = false;
    document.getElementById('balanceGame').innerText = playerData.balance;
};

showSection('profile');
</script>
</body>
</html>
